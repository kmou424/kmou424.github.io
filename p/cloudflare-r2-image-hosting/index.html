<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="折腾一下图床，每日白嫖 Cloudflare +1"><title>Cloudflare R2+CDN缓存实现无限配额图床</title><link rel=canonical href=https://labs.kmou424.moe/p/cloudflare-r2-image-hosting/><link rel=stylesheet href=/scss/style.min.488c37c98d72872988ed51846594451762efbffb8d914a834259ce0a49ec365c.css><meta property='og:title' content="Cloudflare R2+CDN缓存实现无限配额图床"><meta property='og:description' content="折腾一下图床，每日白嫖 Cloudflare +1"><meta property='og:url' content='https://labs.kmou424.moe/p/cloudflare-r2-image-hosting/'><meta property='og:site_name' content='SaikaLab'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='exploration'><meta property='article:tag' content='cdn'><meta property='article:tag' content='image-hosting'><meta property='article:published_time' content='2024-05-01T19:22:00+08:00'><meta property='article:modified_time' content='2024-05-01T19:22:00+08:00'><meta name=twitter:title content="Cloudflare R2+CDN缓存实现无限配额图床"><meta name=twitter:description content="折腾一下图床，每日白嫖 Cloudflare +1"></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><div id=article-toolbar style=position:sticky;top:5px;z-index:1000><a href=/ class=back-home><svg class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg>
<span>返回</span></a></div><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><ol><li><a href=#前言>前言</a></li><li><a href=#部署>部署</a><ol><li><a href=#激活-r2-服务>激活 R2 服务</a></li><li><a href=#创建存储桶>创建存储桶</a></li><li><a href=#配置缓存>配置缓存</a></li><li><a href=#完成>完成</a></li></ol></li><li><a href=#测试>测试</a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/technologies/ style=background-color:#2a9d8f;color:#fff>技术</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/cloudflare-r2-image-hosting/>Cloudflare R2+CDN缓存实现无限配额图床</a></h2><h3 class=article-subtitle>折腾一下图床，每日白嫖 Cloudflare +1</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>May 01, 2024</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 4 分钟</time></div></footer></div></header><section class=article-content><h3 id=前言><a href=#%e5%89%8d%e8%a8%80 class=header-anchor></a>前言</h3><p>这不刚重建了博客吗，既然要写博客，那文章中的图片自然也是重要的组成部分。对于图片通常有两种解决方案：</p><ol><li><p>直接塞给博客程序管理，由本站直接提供图片</p></li><li><p>使用外挂的图床/对象存储服务，通过外链的方式引入文章</p></li></ol><p>咱们当然选择后者，毕竟部署本站的香港小鸡也不是无限流量，要是<del>某天本站火了</del>遇到大流量的情况不得直接暴毙了。（当然其实也不是不能用这种方案，比如用带慈善家 Cloudflare 开启小云朵做全站缓存也是 OK 的，图片能够全部命中缓存。但是本站服务器在香港，套一层 Cloudflare CDN 的话那浏览体验我都不敢想。）</p><p>上网找了一圈，听说七牛云挺好的，闻言博主就去瞅了瞅，还发现自己曾经注册过账号。但是不知道为什么他们家登录页面响应式全部挂掉了，登也登不上，只能找找其他服务商了。</p><p>但说实在的，博主用的服务一般会追求稳妥，即考虑极端情况。这么一想，那些可以白嫖的对象存储服务也都有限额，稍不注意被恶意刷流量，导致超出额度了可不就难受了吗（叠个甲：博主没有预设人性丑恶，只是多年上网冲浪的经验）。所以结论是，还是得找一个能命中 CDN 缓存的服务。如果用 OSS+CDN 的话几乎是没有可白嫖的，这时我想到了带慈善家 Cloudflare。</p><p>此前博主是不知道 Cloudflare 提供对象存储服务的，上网查了一下才知道他们家的对象存储服务叫 R2，提供免费的每月 10G 空间、1000 万次读操作、100 万次写操作，并且存储桶默认都在他们家自己的节点上（这不废话），本身图片就是静态资源，这样的话，只要路径统一，岂不是可以把图片缓存在他们家的边缘节点上实现免费无限配额？</p><h3 id=部署><a href=#%e9%83%a8%e7%bd%b2 class=header-anchor></a>部署</h3><h4 id=激活-r2-服务><a href=#%e6%bf%80%e6%b4%bb-r2-%e6%9c%8d%e5%8a%a1 class=header-anchor></a>激活 R2 服务</h4><p>先前往 <a class=link href=https://dash.cloudflare.com/ target=_blank rel=noopener>Cloudflare Dashboard</a> 打开侧边栏，进入 R2 页面。</p><p>需要绑一张信用卡（或者 PayPal 也是可以的）后才能激活 R2，这里就自行解决了。</p><h4 id=创建存储桶><a href=#%e5%88%9b%e5%bb%ba%e5%ad%98%e5%82%a8%e6%a1%b6 class=header-anchor></a>创建存储桶</h4><p>名字随意，地区可以选一下亚太地区（会影响存储桶选择节点的倾向）。</p><p><img src=https://img.kmou424.moe/7bf1d6388906f335a7762ea08ebff3ded61e196400fe0cbd888628c9c565586f.png loading=lazy></p><p><img src=https://img.kmou424.moe/ed4a3a31650753503b07a6ab753fb27359535817b271f70ba74ac71ea8cc25a6.png loading=lazy></p><p>现在就可以来到对象这一栏上传图片，使用你绑定的域名/图片路径即可访问。如：<a class=link href=https://img.kmou424.moe/4ffdff92ffce796eec152512472a95a4c7d73fbef57a76641b2ab16710da9d67.png target=_blank rel=noopener>https://img.kmou424.moe/4ffdff92ffce796eec152512472a95a4c7d73fbef57a76641b2ab16710da9d67.png</a></p><p><img src=https://img.kmou424.moe/4ffdff92ffce796eec152512472a95a4c7d73fbef57a76641b2ab16710da9d67.png loading=lazy></p><p>截至目前图床已经可以正常使用了，但是还不够，还需要配置缓存规则使得对图片的请求全部命中在 Cloudflare 边缘节点上的缓存。</p><h4 id=配置缓存><a href=#%e9%85%8d%e7%bd%ae%e7%bc%93%e5%ad%98 class=header-anchor></a>配置缓存</h4><p>转到你的域名对应的 Zone，打开侧边栏->Caching/缓存->Cache Rules，点击创建规则来配置一条专门用于图床的规则。</p><p>同样是名称随意，匹配规则里选择<strong>字段：URL 完整，运算符：包含，值：https://img.kmou424.moe/（即你刚刚配置的图床域名）</strong>。这条规则的含义是以此 URL 请求的资源会命中这条缓存规则。</p><p>缓存资格选择符合缓存条件，如果选绕过缓存的话，会禁用缓存。</p><p><img src=https://img.kmou424.moe/f7ab248173caf819dcd48ff4edb92dd16543d56084defc76a33bba7cb34b150e.png loading=lazy></p><p>边缘 TTL，即缓存在 Cloudflare 边缘节点上的过期时间，我这里设为了 6 个月，代表图片缓存后 6 个月才会过期：第一次请求时会把图片缓存上去，接下来 6 个月内的请求都会命中这个缓存，等到过期后的第一次请求才会去存储桶中获取文件并再次缓存（过期前删除了存储桶中的文件也不会影响这里的缓存，除非手动清除）。</p><p>浏览器 TTL 是响应中返回给浏览器的建议过期时间，这里我选择的是 8 小时。图片会留存在浏览器的缓存中 8 小时，期间如果再次访问图片，返回的状态码将会是 304 Not Modified（资源是从本地缓存中取出的）。如果没有手动清除浏览器缓存，则图片应当会在 8 小时后过期，并从本地缓存中清除掉。</p><p><img src=https://img.kmou424.moe/9fd93f0aa80dea8d39c6cb27645fc89c372713389452d714d7a0318b74b2ebe5.png loading=lazy></p><p>编辑好后，点击页面底部的部署即可生效（30s 左右）。</p><h4 id=完成><a href=#%e5%ae%8c%e6%88%90 class=header-anchor></a>完成</h4><p>至此整个部署过程就已经完成，接下来只需要在文章中引用图床 URL/路径即可访问到上传的图片，进缓存之后就不用再担心配额的消耗问题了。</p><h3 id=测试><a href=#%e6%b5%8b%e8%af%95 class=header-anchor></a>测试</h3><p>作为一个稳健的白嫖党，那还是要测试一下缓存保不保真的，万一没缓存上那就要花 dollar 了，这可是钱的事，对于博主这种穷逼来说，要是整点账单出来就得饿饭了。</p><p>所以就在写本文的今天（2024/5/1）下午 5:40 左右，博主使用 Apifox 做了一个小压测（模拟请求图片资源），并发拉到 100，一共测试了 10 分钟。测试结果如图：</p><p><img src=https://img.kmou424.moe/71b3107694908661edaf5a69fe02527430fc23075059fba04a6a69dd2bd22368.png loading=lazy></p><p>可以看到一共请求了约 2.4w 次（不过并发是一直上不去，且比较平稳，看来是 Cloudflare 给限到这个水平了）。等待到 6 点之后，来看看 Cloudflare 的 Zone 统计数据：</p><p><img src=https://img.kmou424.moe/5bfc701aed79c99aa4012f6397c8da4f568d0e1b296ebf2678c1387fe758f6cb.png loading=lazy></p><p>看上去是成了，一小时内命中缓存的比例达到了<del>惊人的</del> 96%，这还是针对这整个二级域名的数据（实际上还挂有其他服务，并且是关掉缓存的）。</p><p>再来看看 R2 的统计数据：</p><p><img src=https://img.kmou424.moe/2e86fcf675f437fca6a040fe83e36909bfbb58b61a63acc4c3a337316b1a109c.png loading=lazy></p><p>R2 的数据很奇怪，B 类操作（即读取）比起开测之前涨了 300 多，开测之前博主大概看了一下是 66 来着。不知道在这 2.4w 次请求里为什么会有这么 300 次没有命中缓存，太奇怪了嗷。</p><p>不过这样的效果已经很好了，个人博客使用根本不可能把每月的免费配额花完。至此，这个免费 10G 无限配额的图床就搭好了。</p><p>白嫖，爽！</p></section><footer class=article-footer><section class=article-tags><a href=/tags/exploration/>折腾</a>
<a href=/tags/cdn/>CDN</a>
<a href=/tags/image-hosting/>图床</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css integrity=sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js integrity=sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8 crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{const e=document.querySelector(".main-article");renderMathInElement(e,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],ignoredClasses:["gist"]})})</script></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/sing-box-chain-proxy-for-crawler/><div class=article-details><h2 class=article-title>用 sing-box + Cloudflare WARP 搭建链式代理，为爬虫提供稳定 IP</h2></div></a></article></div></div></aside><script src=//unpkg.com/@waline/client@v2/dist/waline.js></script><link href=//unpkg.com/@waline/client@v2/dist/waline.css rel=stylesheet><div id=waline class=waline-container></div><style>.waline-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding);--waline-font-size:var(--article-font-size)}.waline-container .wl-count{color:var(--card-text-color-main)}</style><script>Waline.init({avatar:"",dark:'html[data-scheme="dark"]',el:"#waline",emoji:["//unpkg.com/@waline/emojis@1.2.0/bmoji","//unpkg.com/@waline/emojis@1.2.0/bilibili","//unpkg.com/@waline/emojis@1.2.0/tieba"],lang:"zh-CN",locale:{admin:"Admin",placeholder:null},login:"force",meta:["name","email","url"],placeholder:"",requiredMeta:["name","email"],serverURL:"https://waline.kmou424.moe/"})</script><footer class=site-footer><section class=copyright>&copy;
2018 -
2025 <a href=/>SaikaLab</a></section><section class=powerby>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>